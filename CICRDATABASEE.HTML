<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CICR Management Portal</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<style>
/* --- CICR "DARK TECH" THEME VARIABLES --- */
:root {
    --color-bg-deep: #0b0c10;
    --color-bg-panel: rgba(31, 40, 51, 0.95);
    --color-text-main: #c5c6c7;
    --color-accent: #66fcf1;
    --color-accent-dim: #45a29e;
    --color-success: #2ecc71;
    --color-danger: #e74c3c;
    --border-radius: 4px;
    --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    --font-heading: 'Montserrat', sans-serif;
    --font-body: 'Roboto', sans-serif;
    --transition-speed: 0.3s;
}

/* --- GLOBAL STYLES --- */
body {
    font-family: var(--font-body);
    margin: 0;
    background-color: transparent; 
    color: var(--color-text-main);
    line-height: 1.6;
    padding-bottom: 40px;
    min-height: 100vh;
}

/* --- BACKGROUND CANVAS --- */
#particles-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none; 
    background: radial-gradient(circle at center, #1f2833 0%, #0b0c10 100%);
}

h1, h2, h3, h4 {
    font-family: var(--font-heading);
    margin-top: 0;
    color: #fff;
    letter-spacing: 0.5px;
}

button { cursor: pointer; font-family: var(--font-heading); }

/* --- TECH GATE ANIMATION (NEW) --- */
#tech-gate {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 20000; /* Topmost */
    pointer-events: none;
    display: flex;
    justify-content: center;
    align-items: center;
}

.gate-left, .gate-right {
    position: absolute;
    top: 0;
    width: 51%; /* Slight overlap to prevent gap */
    height: 100%;
    background: #050505; 
    /* Carbon fiber texture effect */
    background-image: linear-gradient(45deg, #111 25%, transparent 25%, transparent 75%, #111 75%, #111), 
                      linear-gradient(45deg, #111 25%, transparent 25%, transparent 75%, #111 75%, #111);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
    box-shadow: 0 0 50px rgba(0,0,0,0.9);
}

.gate-left {
    left: 0;
    transform: translateX(-100%);
    border-right: 3px solid var(--color-accent-dim);
}

.gate-right {
    right: 0;
    transform: translateX(100%);
    border-left: 3px solid var(--color-accent-dim);
}

.gate-lock {
    z-index: 20001;
    color: var(--color-accent);
    font-family: var(--font-heading);
    font-size: 24px;
    letter-spacing: 5px;
    opacity: 0;
    transition: opacity 0.2s;
    text-shadow: 0 0 15px var(--color-accent);
    background: rgba(0,0,0,0.9);
    padding: 15px 30px;
    border: 2px solid var(--color-accent);
    border-radius: 4px;
    transform: scale(0.8);
}

/* Active State for Gate */
#tech-gate.active .gate-left { transform: translateX(0); }
#tech-gate.active .gate-right { transform: translateX(0); }
#tech-gate.active .gate-lock { opacity: 1; transform: scale(1); transition-delay: 0.6s; }


/* --- SPLASH SCREEN --- */
#splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--color-bg-deep);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease;
}
#splash-screen-logo {
    width: 120px;
    height: 120px;
    margin-bottom: 20px;
    border-radius: 50%;
    border: 3px solid var(--color-accent);
    box-shadow: 0 0 20px var(--color-accent-dim);
    animation: pulse 2s infinite;
}
#splash-screen p {
    font-size: 16px;
    color: var(--color-accent);
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
}

/* --- SUCCESS OVERLAY --- */
#action-success-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 10001; 
    display: none; 
    flex-direction: column;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}
.success-container { text-align: center; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.robot-emoji { font-size: 80px; margin-bottom: 10px; display: block; animation: bounce 1s infinite alternate; }
.big-green-tick { font-size: 100px; color: var(--color-success); line-height: 1; display: block; text-shadow: 0 0 30px rgba(46, 204, 113, 0.6); }
.success-message { font-family: var(--font-heading); font-size: 24px; color: #fff; margin-top: 20px; text-transform: uppercase; letter-spacing: 2px; }

@keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
@keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }

/* --- LOGIN SUCCESS SCREEN --- */
#success-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(11, 12, 16, 0.95);
    z-index: 9998;
    display: none; 
    flex-direction: column;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(10px);
}
.success-icon { font-size: 60px; margin-bottom: 20px; animation: unlock 0.5s ease-out forwards; }
.success-text { font-family: var(--font-heading); font-size: 24px; color: var(--color-accent); letter-spacing: 2px; text-transform: uppercase; text-align: center; text-shadow: 0 0 10px var(--color-accent-dim); }
.success-subtext { font-family: var(--font-body); font-size: 14px; color: var(--color-text-main); margin-top: 10px; opacity: 0.8; }

@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(102, 252, 241, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(102, 252, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(102, 252, 241, 0); } }
@keyframes unlock { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }

/* --- HEADER --- */
.header-branding {
    background: var(--color-bg-panel);
    border-bottom: 2px solid var(--color-accent);
    padding: 25px 20px 45px 20px;
    text-align: center;
    position: relative;
    box-shadow: var(--box-shadow);
    margin-bottom: 30px;
    backdrop-filter: blur(5px);
}

.header-logo {
    position: absolute;
    top: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #fff;
    padding: 2px;
    border: 2px solid var(--color-accent);
    object-fit: contain;
}
.header-logo-left { left: 40px; }
.header-logo-right { right: 100px; } 

/* USER AVATAR LOGO */
#user-avatar-display {
    position: absolute;
    top: 25px;
    right: 20px; 
    width: 50px;
    height: 50px;
    background: var(--color-accent);
    color: #0b0c10;
    border-radius: 50%;
    display: none; 
    align-items: center;
    justify-content: center;
    font-family: var(--font-heading);
    font-weight: 800;
    font-size: 20px;
    border: 3px solid #fff;
    box-shadow: 0 0 15px var(--color-accent);
    z-index: 100;
    cursor: pointer;
    background-size: cover;
    background-position: center;
    overflow: hidden;
}

h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 5px;
    color: #fff;
    text-transform: uppercase;
}
h1 span { color: var(--color-accent); }

.designer-credit {
    font-size: 11px;
    color: var(--color-accent-dim);
    margin-top: 5px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#digital-clock {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: var(--color-accent);
    font-family: 'Montserrat', sans-serif;
    background: rgba(0,0,0,0.3);
    padding: 4px 15px;
    border-radius: 20px;
    border: 1px solid var(--color-accent-dim);
    width: max-content;
}

#theme-toggle-btn { display: none; }

/* --- NAVIGATION --- */
.container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 20px;
    position: relative;
    z-index: 1;
}

.tab-navigation {
    display: flex;
    justify-content: center;
    background-color: var(--color-bg-panel);
    border-bottom: 1px solid var(--color-accent-dim);
    margin-bottom: 30px;
    flex-wrap: wrap;
    border-radius: 4px;
}

.tab-link {
    padding: 15px 15px;
    color: var(--color-text-main);
    text-decoration: none;
    font-weight: 600;
    transition: all var(--transition-speed);
    font-size: 12px;
    text-transform: uppercase;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    flex-grow: 1;
    text-align: center;
}

.tab-link:hover { color: #fff; background: rgba(255,255,255,0.05); }
.tab-link.active { color: var(--color-accent); border-bottom-color: var(--color-accent); background: rgba(102, 252, 241, 0.1); }

.tab-content { display: none; animation: fadeIn 0.4s ease-in-out; }
.tab-content.active { display: block; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- CARDS & FORMS --- */
.energy-frame {
    background: var(--color-bg-panel);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid #2b3642;
    position: relative;
}

h2 {
    color: var(--color-accent);
    font-size: 20px;
    border-left: 4px solid var(--color-accent);
    padding-left: 15px;
    margin-bottom: 25px;
}
h3 { color: #fff; font-size: 16px; margin-bottom: 15px; text-transform: uppercase; }

.controls-container, .scheduling-grid, .member-control-grid, .profile-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}
.full-span { grid-column: span 2; }

label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    color: var(--color-accent-dim);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

input, select, textarea {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #333;
    border-radius: 2px;
    background-color: #121418;
    font-family: var(--font-body);
    font-size: 14px;
    color: #fff;
    transition: all 0.2s;
    box-sizing: border-box;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--color-accent);
    background-color: #000;
    box-shadow: 0 0 5px rgba(102, 252, 241, 0.3);
}

/* BIG PASSWORD DOTS FIX */
input[type="password"] {
    font-family: 'Verdana', sans-serif; /* Cleaner dots */
    letter-spacing: 2px;
    font-size: 16px;
}

#year-select { height: 120px; }

/* Date Picker Wrapper */
.date-picker-wrapper { display: flex; gap: 8px; }
#open-calendar-btn, #open-calendar-scheduler-btn, #open-calendar-start-btn, #open-calendar-end-btn {
    background-color: var(--color-bg-panel);
    color: var(--color-accent);
    border: 1px solid var(--color-accent);
    border-radius: 2px;
    width: 46px;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#open-calendar-btn:hover { background-color: var(--color-accent); color: #000; }

/* --- BUTTONS --- */
button.btn-utility, button.status-button, #create-gmeet-btn, #schedule-meeting-btn, #add-member-btn, #remove-member-btn, #login-form button[type="submit"], #add-permanent-group-btn, #save-data-btn, #add-project-btn, #chat-send-btn, #update-profile-btn, #logout-btn, #send-otp-btn, #verify-otp-btn {
    border: none;
    padding: 12px 24px;
    border-radius: 2px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.2s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

#create-gmeet-btn, #schedule-meeting-btn, #add-member-btn, #add-permanent-group-btn, #add-project-btn, #chat-send-btn, #update-profile-btn, #send-otp-btn, #verify-otp-btn {
    background-color: var(--color-accent-dim);
    color: #fff;
}
#create-gmeet-btn:hover, #schedule-meeting-btn:hover, #add-member-btn:hover, #add-project-btn:hover, #chat-send-btn:hover, #update-profile-btn:hover, #send-otp-btn:hover, #verify-otp-btn:hover {
    background-color: var(--color-accent);
    color: #0b0c10;
    box-shadow: 0 0 10px var(--color-accent);
}

.btn-save { background-color: var(--color-success) !important; color: #fff !important; }
.btn-save:hover { background-color: #27ae60 !important; transform: scale(1.02); }

#remove-member-btn, .btn-clear-history, .btn-remove-selected, .btn-delete-project, #logout-btn {
    background-color: transparent;
    border: 1px solid var(--color-danger) !important;
    color: var(--color-danger) !important;
}
#remove-member-btn:hover, .btn-clear-history:hover, .btn-remove-selected:hover, .btn-delete-project:hover, #logout-btn:hover {
    background-color: var(--color-danger);
    color: #fff !important;
}

.btn-export-excel {
    background-color: transparent;
    border: 1px solid var(--color-success) !important;
    color: var(--color-success) !important;
}
.btn-export-excel:hover {
    background-color: var(--color-success);
    color: #fff !important;
}

/* --- LISTS --- */
#attendance-list {
    list-style: none;
    padding: 0;
    margin: 20px 0;
    max-height: 450px;
    overflow-y: auto;
    border: 1px solid #333;
    border-radius: 2px;
    background: #121418;
}

.student-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #333;
    background-color: #121418;
    transition: background-color 0.2s;
}
.student-item:last-child { border-bottom: none; }
.student-item:hover { background-color: #1a1d23; }

.student-name { font-weight: 600; color: #fff; font-size: 15px; }
.student-id { font-size: 12px; color: var(--color-accent-dim); margin-top: 2px; }

.status-controls { display: flex; gap: 8px; }
.status-button {
    padding: 6px 14px !important;
    font-size: 10px !important;
    border-radius: 2px !important;
    border: 1px solid #444 !important;
    background: transparent;
    color: #888;
    box-shadow: none !important;
}

.student-item.present { border-left: 4px solid var(--color-success); background-color: rgba(46, 204, 113, 0.1); }
.student-item.absent { border-left: 4px solid var(--color-danger); background-color: rgba(231, 76, 60, 0.1); }
.student-item.unmarked { border-left: 4px solid #444; }

.status-button[style*="opacity: 1.0"] { color: #fff !important; border-color: transparent !important; box-shadow: 0 0 5px rgba(0,0,0,0.5) !important; }
.btn-present[style*="opacity: 1.0"] { background-color: var(--color-success) !important; }
.btn-absent[style*="opacity: 1.0"] { background-color: var(--color-danger) !important; }
.btn-unmarked[style*="opacity: 1.0"] { background-color: #444 !important; }

/* --- PROJECTS MODULE --- */
.project-card {
    background: #121418;
    border: 1px solid #333;
    padding: 20px;
    margin-bottom: 15px;
    border-left: 3px solid var(--color-accent);
    position: relative;
}
.project-card h4 { color: var(--color-accent); margin-bottom: 5px; font-size: 16px; }
.project-info { font-size: 13px; color: #bbb; margin-bottom: 5px; }
.project-link a { color: var(--color-accent-dim); text-decoration: none; font-size: 12px; }
.project-link a:hover { text-decoration: underline; color: var(--color-accent); }
.btn-delete-project {
    position: absolute;
    top: 15px;
    right: 15px;
    padding: 5px 10px;
    font-size: 10px;
}

/* --- CHAT MODULE --- */
.chat-display {
    height: 400px;
    overflow-y: auto;
    background: #121418;
    border: 1px solid #333;
    padding: 20px;
    border-radius: 4px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}
.chat-message {
    max-width: 75%;
    padding: 10px 15px;
    border-radius: 4px;
    font-size: 13px;
    position: relative;
    line-height: 1.4;
}
.msg-self {
    align-self: flex-end;
    background: rgba(69, 162, 158, 0.2);
    color: #fff;
    border: 1px solid var(--color-accent);
    text-align: right;
}
.msg-other {
    align-self: flex-start;
    background: #1f2833;
    color: #c5c6c7;
    border: 1px solid #333;
}
.msg-meta {
    font-size: 10px;
    opacity: 0.6;
    margin-bottom: 4px;
    display: block;
    font-weight: 700;
    color: var(--color-accent-dim);
}
.chat-controls {
    display: flex;
    gap: 10px;
}
#chat-input {
    flex-grow: 1;
}

/* History & Reports */
.history-item { background: #121418; border: 1px solid #333; margin-bottom: 12px; border-radius: 2px; }
.history-header-wrapper { padding: 12px 20px; display: flex; align-items: center; background: #121418; }
.history-header-btn { background: none; border: none; text-align: left; width: 100%; display: flex; justify-content: space-between; font-family: var(--font-body); font-size: 14px; color: #ddd; }
.history-details { background-color: #0b0c10; border-top: 1px solid #333; font-size: 13px; padding: 20px; color: #aaa; }

#personal-report-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
#personal-report-table th { background-color: #121418; color: var(--color-accent); font-weight: 600; text-transform: uppercase; font-size: 12px; padding: 15px; border: 1px solid #333; }
#personal-report-table td { padding: 12px 15px; border: 1px solid #333; font-size: 14px; background: #1f2833; color: #ddd; }

/* Login & Registration */
#login-form-card {
    max-width: 400px;
    margin: 80px auto;
    text-align: center;
    border: 1px solid var(--color-accent);
    box-shadow: 0 0 20px rgba(102, 252, 241, 0.1);
}
#login-form { display: flex; flex-direction: column; gap: 20px; }
#login-form button { margin-top: 10px; width: 100%; padding: 15px; font-size: 15px; background-color: var(--color-accent); color: #0b0c10; }
.toggle-auth-link {
    color: var(--color-accent);
    cursor: pointer;
    font-size: 12px;
    text-decoration: underline;
    margin-top: 10px;
    display: inline-block;
}
.forgot-password-link { color: var(--color-accent-dim); font-size: 12px; text-decoration: none; margin-top: 5px; display: inline-block; }

/* Password Eye Icon Style */
.password-wrapper {
    position: relative;
    width: 100%;
}
.password-toggle-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    width: 20px;
    height: 20px;
    opacity: 0.7;
    transition: opacity 0.2s;
    fill: #fff;
    z-index: 5;
}
.password-toggle-icon:hover { opacity: 1; }

/* Registration Extra Fields */
#registration-fields {
    display: none; /* Hidden by default */
    grid-column: span 1;
    width: 100%;
}

/* OTP SECTION */
#otp-section {
    display: none; /* Hidden unless needed */
    margin-bottom: 20px;
    border: 1px solid #333;
    padding: 15px;
    border-radius: 4px;
    background: rgba(255,255,255,0.05);
}
#otp-input-wrapper { display: none; margin-top: 10px; }
#otp-status { font-size: 12px; color: var(--color-success); margin-top: 5px; }

/* Responsive */
@media (max-width: 768px) {
    .controls-container, .scheduling-grid, .member-control-grid { grid-template-columns: 1fr; gap: 15px; }
    .header-logo-left, .header-logo-right { display: none; }
    .full-span { grid-column: span 1; }
    .tab-link { flex: 1 1 auto; text-align: center; margin: 2px; font-size: 10px; padding: 10px 5px; }
    .header-branding { padding: 20px 15px 40px 15px; }
    #splash-screen-logo { width: 100px; height: 100px; }
    .success-text { font-size: 18px; }
}
</style>
</head>
<body>

<div id="tech-gate">
    <div class="gate-left"></div>
    <div class="gate-right"></div>
    <div class="gate-lock">PROCESSING</div>
</div>

<canvas id="particles-canvas"></canvas>

<div id="splash-screen">
    <img src="https://media.licdn.com/dms/image/v2/D560BAQHZvHdAAzLOxg/company-logo_200_200/company-logo_200_200/0/1705683330825/cicrjiit128_logo?e=1767225600&v=beta&t=SAJZZCC-p-7Eab0gESU8kj_i4CPzBKTbzeloh0kRUQc" 
         alt="CICR Logo" 
         id="splash-screen-logo">
    <p>Creativity Innovation Cell in Robotics</p>
</div>

<div id="success-screen" style="display: none;">
    <div class="success-icon">ðŸ”“</div>
    <div class="success-text">ACCESS GRANTED<br><span style="color:white; font-size: 20px;">CONGRATULATIONS</span></div>
    <div class="success-subtext">WELCOME TO CICR COMMAND CENTER</div>
</div>

<div id="action-success-overlay">
    <div class="success-container">
        <span class="robot-emoji">ðŸ¤–</span>
        <span class="big-green-tick">âœ“</span>
        <div class="success-message">DATA LOGGED SUCCESSFULLY</div>
    </div>
</div>

<div class="container">
	<div class="header-branding" role="banner">
		<img src="https://media.licdn.com/dms/image/v2/D560BAQHZvHdAAzLOxg/company-logo_200_200/company-logo_200_200/0/1705683330825/cicrjiit128_logo?e=1767225600&v=beta&t=SAJZZCC-p-7Eab0gESU8kj_i4CPzBKTbzeloh0kRUQc" alt="CICR Organization Logo" class="header-logo header-logo-left">
		<img src="https://media.licdn.com/dms/image/v2/D560BAQHZvHdAAzLOxg/company-logo_200_200/company-logo_200_200/0/1705683330825/cicrjiit128_logo?e=1767225600&v=beta&t=SAJZZCC-p-7Eab0gESU8kj_i4CPzBKTbzeloh0kRUQc" alt="CICR Organization Logo" class="header-logo header-logo-right">
		
        <div id="user-avatar-display" title="My Profile">?</div>

		<h1>CICR <span>MANAGEMENT</span> PORTAL</h1>
        <p style="margin:0; font-size:14px; color: var(--color-accent-dim); letter-spacing: 1px;">Creativity Innovation Cell in Robotics</p>
		<p class="designer-credit">SYSTEM DESIGNED BY KUMAR SHAURYA & PRIYANSHI SAINI</p>
		<div id="digital-clock">Loading...</div>
	</div>

	<div id="login-screen" style="display: none;">
		<div id="login-form-card" class="energy-frame">
			<h2 id="auth-title">AUTHORIZED ACCESS</h2>
			<form id="login-form">
				<div>
					<label for="username" id="label-user">Email or Phone No.</label>
					<input type="text" id="username" required placeholder="Enter Email/Phone (or Master ID)">
				</div>
                
                <div id="registration-fields">
                    <div id="otp-section">
                        <label style="color:var(--color-accent);">VERIFICATION REQUIRED</label>
                        <button type="button" id="send-otp-btn" style="width:100%;">SEND OTP TO CONTACT</button>
                        <div id="otp-input-wrapper">
                            <input type="text" id="otp-input" placeholder="Enter 6-Digit Code" style="text-align:center; letter-spacing:5px;">
                            <button type="button" id="verify-otp-btn" style="width:100%; margin-top:5px;">VERIFY CODE</button>
                        </div>
                        <p id="otp-status"></p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="reg-name">Full Name</label>
                        <input type="text" id="reg-name" placeholder="Your Name">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label for="reg-year">Year</label>
                        <select id="reg-year">
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label for="reg-batch">Batch</label>
                        <input type="text" id="reg-batch" placeholder="e.g. B14">
                    </div>
                </div>

				<div style="position: relative;">
					<label for="password">Password</label>
                    <div class="password-wrapper">
					    <input type="password" id="password" required placeholder="Enter Password" style="padding-right: 40px; font-family: 'Verdana', sans-serif;">
                        <div id="toggle-password" class="password-toggle-icon">
                            <svg class="eye-show" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                            <svg class="eye-hide" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;"><path d="M11.83 9L15 12.17V12c0-1.66-1.34-3-3-3h-.17zm-4.3.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm-2.53 1.1l9.53 9.53 1.27-1.27-3.23-3.23c-1.39.73-2.95 1.12-4.57 1.12-5 0-9.27-3.11-11-7.5 1.24-3.14 3.75-5.6 6.84-6.84l-2.5-2.5 1.27-1.27.46.46L6.27 10.9zm13.23-4.4c1.65 1.38 3 3.14 3.76 5.5-1.73 4.39-6 7.5-11 7.5-1.04 0-2.05-.13-3.03-.38l2.25-2.25c.25.08.52.13.78.13 2.76 0 5-2.24 5-5 0-.26-.05-.53-.13-.78l2.25-2.25c.38.62.74 1.28 1.12 2.03z"/></svg>
                        </div>
                    </div>
				</div>
                <div style="text-align: right; display:flex; justify-content:space-between; margin-top:5px;">
                    <span id="toggle-auth-btn" class="toggle-auth-link">Create New Account</span>
				    <a href="mailto:kshaurya209@gmail.com?subject=CICR%20Password%20Reset" class="forgot-password-link">Forgot Password?</a>
                </div>
				<button type="submit" id="login-btn">LOGIN</button>
			</form>
			<p id="login-error" style="color:var(--color-danger); margin-top:15px; display:none; font-size:13px; font-weight:600;">ACCESS DENIED. INVALID CREDENTIALS.</p>
		</div>
	</div>
Â  Â Â 
	<div id="app-content" style="display: none;">
Â  Â  Â  Â  <nav class="tab-navigation" role="tablist">
Â  Â  Â  Â  Â  Â  <a class="tab-link active" data-tab="attendance" role="tab" aria-selected="true">ATTENDANCE</a>
Â  Â  Â  Â  Â  Â  <a class="tab-link" data-tab="history" role="tab" aria-selected="false">LOGS</a>
Â  Â  Â  Â  Â  Â  <a class="tab-link" data-tab="reports" role="tab" aria-selected="false">ANALYTICS</a>
Â  Â  Â  Â  Â  Â  <a class="tab-link" data-tab="projects" role="tab" aria-selected="false">PROJECTS</a>
            <a class="tab-link" data-tab="chat" role="tab" aria-selected="false">COMMUNITY</a>
Â  Â  Â  Â  Â  Â  <a class="tab-link" data-tab="scheduling" role="tab" aria-selected="false">SCHEDULING</a>
Â  Â  Â  Â  Â  Â  <a class="tab-link" data-tab="admin" role="tab" aria-selected="false">ADMIN</a>
            <a class="tab-link" data-tab="account" role="tab" aria-selected="false">MY ACCOUNT</a>
Â  Â  Â  Â  </nav>

		<div class="main-content">
Â  Â  Â  Â  Â  Â  <section id="attendance-content" class="tab-content active" role="tabpanel">
				<div id="attendance-card" class="energy-frame">
					<h2 id="attendance-heading">Attendance Sheet</h2>
					<div class="controls-container">
						<div>
							<label for="attendance-date">Session Date</label>
							<div class="date-picker-wrapper">
								<input type="date" id="attendance-date" />
								<button type="button" id="open-calendar-btn">ðŸ“…</button>
							</div>
						</div>
						<div>
							<label for="attendance-taker-select">Recorded By</label>
							<select id="attendance-taker-select"><option value="" disabled selected>-- Select Member --</option></select>
						</div>
						<div>
							<label for="year-select">Group Filter (Select Multiple)</label>
                            <p style="font-size:10px; margin:0; color:#888;">* Hold Ctrl/Cmd to select multiple</p>
							<select id="year-select" multiple size="4"></select>
						</div>
						<div>
							<label for="attendance-subject">Meeting Topic</label>
							<select id="attendance-subject" onchange="handleTopicChange()">
								<option value="Research Strategy" selected>Research Strategy Session</option>
								<option value="Patent Review">Patent Review Committee</option>
								<option value="Budget Planning">Quarterly Budget Planning</option>
								<option value="Project Update">Project Progress Update</option>
								<option value="Other">Other Meeting Topic</option>
							</select>
							<input type="text" id="custom-topic-input" placeholder="Enter Custom Topic" style="display:none; margin-top:5px;" />
						</div>
						<div class="full-span">
							<label for="meeting-summary">Meeting Summary</label>
							<textarea id="meeting-summary" rows="3" placeholder="Enter brief summary..."></textarea>
						</div>
						<div class="full-span">
							<button id="create-gmeet-btn">Google Meet & Calendar Link</button>
						</div>
					</div>
					<p class="current-class-display">Current Session: <strong id="current-subject-display" style="color: var(--color-accent);">Research Strategy Session</strong></p>
					<ul id="attendance-list"><li>Select a Group Filter to load members.</li></ul>
					<div id="attendance-summary" class="summary-card">
						<div class="summary-header" style="display: flex; justify-content: space-between; align-items: center;">
							<h3 style="margin: 0; color: var(--color-accent);">Metrics</h3>
							<button id="save-data-btn" class="status-button btn-save">Save Data</button>
						</div>
						<div class="summary-totals">
							<p>Total Present: <strong id="total-present" style="color: #fff;">0</strong></p>
							<p>Total Absent: <strong id="total-absent" style="color: #fff;">0</strong></p>
							<p>Ratio: <strong id="present-percentage" class="percentage-value">0.0%</strong></p>
						</div>
						<h4 style="margin-top:15px; font-size:14px; color: #ddd;">Absentees:</h4>
						<ul id="absent-list" style="list-style-type: none; padding-left: 0; color: var(--color-danger);"><li>-</li></ul>
					</div>
				</div>
			</section>

Â  Â  Â  Â  Â  Â  <section id="history-content" class="tab-content" role="tabpanel">
				<div id="history-card" class="energy-frame">
					<h2 id="history-heading">Meeting Logs</h2>
					<div class="history-controls" style="display: flex; gap: 10px; margin-bottom: 20px;">
						<button id="export-excel-btn" class="btn-utility btn-export-excel">Export CSV (Excel)</button>
						<button id="remove-selected-btn" class="btn-utility btn-remove-selected">Delete Selected</button>
						<button id="clear-history-btn" class="btn-utility btn-clear-history">Clear All</button>
					</div>
					<ul id="history-list" class="history-list" style="list-style: none; padding:0;"><li>Loading...</li></ul>
				</div>
			</section>

Â  Â  Â  Â  Â  Â  <section id="reports-content" class="tab-content" role="tabpanel">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="personal-report-card" class="energy-frame">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="report-heading">Performance Analytics</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="personal-report-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Member Name</th><th>Group</th><th style="text-align: right;">Attendance %</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="personal-report-body"><tr><td colspan="3">Calculations Pending...</td></tr></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

            <section id="projects-content" class="tab-content" role="tabpanel">
                <div class="energy-frame">
                    <h2>Add New Project</h2>
                    <div class="controls-container">
                        <div>
                            <label for="project-name">Project Name</label>
                            <input type="text" id="project-name" placeholder="Enter Project Name">
                        </div>
                        <div>
                            <label for="project-type">Project Status/Type</label>
                            <select id="project-type">
                                <option value="live">Live Project</option>
                                <option value="recent">Recent Project</option>
                            </select>
                        </div>
                        <div class="full-span">
                            <label for="project-members">Team Members (Names)</label>
                            <input type="text" id="project-members" placeholder="e.g. Kumar Shaurya, Archit Jain, ...">
                        </div>
                        <div class="full-span">
                            <label for="project-link">Project Link (URL)</label>
                            <input type="url" id="project-link" placeholder="https://github.com/...">
                        </div>
                        <div>
                            <label for="project-start">Start Date</label>
                            <div class="date-picker-wrapper">
                                <input type="date" id="project-start">
                                <button type="button" id="open-calendar-start-btn">ðŸ“…</button>
                            </div>
                        </div>
                        <div>
                            <label for="project-end">End Date</label>
                            <div class="date-picker-wrapper">
                                <input type="date" id="project-end">
                                <button type="button" id="open-calendar-end-btn">ðŸ“…</button>
                            </div>
                        </div>
                        <div class="full-span">
                            <button id="add-project-btn">Add to Database</button>
                        </div>
                    </div>
                </div>

                <div class="energy-frame">
                    <h2 style="color: var(--color-success);">Live Projects</h2>
                    <div id="live-projects-list">
                        <p style="opacity:0.6; font-size:13px;">No live projects active.</p>
                    </div>
                </div>

                <div class="energy-frame">
                    <h2 style="color: var(--color-accent-dim);">Recent Projects</h2>
                    <div id="recent-projects-list">
                        <p style="opacity:0.6; font-size:13px;">No recent projects logged.</p>
                    </div>
                </div>
            </section>

            <section id="chat-content" class="tab-content" role="tabpanel">
                <div class="energy-frame chat-wrapper">
                    <h2>CICR Secure Channel</h2>
                    <p style="font-size: 11px; color: #888; margin-top:-15px; margin-bottom: 20px;">* Note: This secure channel stores data locally. It is for internal logging purposes.</p>
                    <div id="chat-display" class="chat-display">
                        </div>
                    <div class="chat-controls">
                        <input type="text" id="chat-input" placeholder="Transmit message to channel...">
                        <button id="chat-send-btn">SEND</button>
                    </div>
                </div>
            </section>

Â  Â  Â  Â  Â  Â  <section id="scheduling-content" class="tab-content" role="tabpanel">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="scheduling-card" class="energy-frame">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Email Scheduler</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="scheduling-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="schedule-initiator-select">Sender</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="schedule-initiator-select"><option value="" disabled selected>-- Select Sender --</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="schedule-recipient-select">Recipient</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="schedule-recipient-select"><option value="" disabled selected>-- Select Recipient --</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Sender Email</label><input type="email" id="sender-email" placeholder="sender@gmail.com"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Recipient Email</label><input type="text" id="recipient-email" placeholder="recipient@email.com"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="full-span"><label>Subject</label><input type="text" id="schedule-subject" placeholder="Meeting Subject"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
							<label>Date</label>
							<div class="date-picker-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  	<input type="date" id="schedule-date">
								<button type="button" id="open-calendar-scheduler-btn">ðŸ“…</button>
							</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
						<div><label>Time</label><input type="time" id="schedule-time" value="10:00"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Location Type</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="schedule-location-type"><option value="Online">Online</option><option value="Offline">Offline</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Details</label><input type="text" id="schedule-location-details" placeholder="Link or Room No"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="full-span"><button id="schedule-meeting-btn">Generate & Send</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="admin-content" class="tab-content" role="tabpanel">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="admin-tools-wrapper">
                    <div id="group-management-card" class="energy-frame">
                        <h3>Unit / Group Management</h3>
                        <div class="member-control-grid">
                            <div class="full-span"><label>Add New Group</label><input type="text" id="new-permanent-group" placeholder="e.g. Research Subunit Beta"></div>
                            <div class="full-span" style="padding-top:5px;"><button id="add-permanent-group-btn">Add Group</button></div>
                        </div>
                    </div>
                    <div id="member-management-card" class="energy-frame">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>User Database Management</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="member-control-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label>New User Name</label><input type="text" id="new-member-name" placeholder="e.g. Anil Sharma"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Assign Unit</label><select id="new-member-group"></select></div>
                            <div class="full-span" id="custom-group-input-wrapper" style="display:none;"><label>Custom Unit Name</label><input type="text" id="custom-group-input"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="grid-column: span 2;"><button id="add-member-btn">Add User</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="member-control-group full-span"><label>Remove User</label><select id="remove-member-select"></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="padding-top:15px;" class="full-span"><button id="remove-member-btn">Remove User</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

            <section id="account-content" class="tab-content" role="tabpanel">
                <div class="energy-frame">
                    <h2>My Profile</h2>
                    <div class="profile-grid">
                        <div class="full-span" style="text-align:center;">
                            <div style="width: 100px; height: 100px; margin: 0 auto 10px; border-radius:50%; border:2px solid var(--color-accent); overflow:hidden; position:relative;">
                                <div id="profile-preview" style="width:100%; height:100%; background:#222; background-size:cover; background-position:center;"></div>
                            </div>
                            <label for="profile-pic-input" style="cursor:pointer; color:var(--color-accent); text-decoration:underline;">Upload Photo</label>
                            <input type="file" id="profile-pic-input" accept="image/*" style="display:none;">
                        </div>

                        <div>
                            <label>User ID (Email/Phone)</label>
                            <input type="text" id="profile-id" disabled style="opacity: 0.6;">
                        </div>
                        <div>
                            <label>Full Name</label>
                            <input type="text" id="profile-name">
                        </div>
                        <div>
                            <label>Year</label>
                            <select id="profile-year">
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                            </select>
                        </div>
                        <div>
                            <label>Batch</label>
                            <input type="text" id="profile-batch">
                        </div>
                        <div class="full-span" style="margin-top: 10px;">
                            <button id="update-profile-btn">Save Changes</button>
                        </div>
                        <div class="full-span" style="border-top: 1px solid #333; margin-top: 20px; padding-top: 20px;">
                            <button id="logout-btn">LOGOUT</button>
                        </div>
                    </div>
                </div>
            </section>
		</div>

		<footer class="footer" role="contentinfo" style="padding: 20px; text-align: center; font-size: 13px; color: rgba(255,255,255,0.4); border-top: 1px solid #333; margin-top: 40px; background: rgba(0,0,0,0.4);">
			<p id="attendance-taken-by">Attendance Recorded By: [None Selected]</p>
		</footer>
	</div>
	</div>

<script>
const USERNAME = "CICRMEETIN";
const PASSWORD = "CICRMEET25";
let ALL_GROUPS = ["4th Year", "3rd Year", "2nd Year", "1st Year"];
const DEFAULT_STUDENTS = [
	"4th Year: Archit Jain", "3rd Year: Yasharth", "3rd Year: Dhruvi Gupta", "3rd Year: Aryan Varshney", "2nd Year: Aradhaya", "2nd Year: Gunjan", "2nd Year: Aman",
    "1st Year: Divyam Jain", "1st Year: Bhuwan Dhanwani", "1st Year: Kartik Virmani", "1st Year: Kshitika Barnwal", "1st Year: Kumar Shaurya", "1st Year: Vishal Tomar",
    "1st Year: ABHINAV KUMAR SINHA", "1st Year: Yashna Mehta", "1st Year: Agamjot Singh", "1st Year: Labhansh Vashisht", "1st Year: Mohd Nauman Ali", "1st Year: Palash Mittal",
    "1st Year: Priyanshi Saini", "1st Year: Sanjana Kumari", "1st Year: Vardaan Saxena", "1st Year: Pulkit Sukhija", "1st Year: Sanskar Singhal", "1st Year: Paarth Sachdeva",
    "1st Year: Abhisheak Dutt Chandra", "1st Year: Arohan Arora", "1st Year: Rohan Verma", "1st Year: Akshita Gupta", "1st Year: Sarthak Chaurasia", "1st Year: Raghav Seth",
    "1st Year: Istuti Arora", "1st Year: Neeshal", "1st Year: Pakhi Srivastava", "1st Year: Priyanka suman", "1st Year: Shreya Bhatt", "1st Year: Tushar Goyal",
    "1st Year: Parivisha Midha", "1st Year: Parth Mediratta", "1st Year: Tanisha Mehndiratta", "1st Year: Kushagra garg", "1st Year: Navya Chawla", "1st Year: Akansha Nagar",
    "1st Year: Alok Sinha", "1st Year: Gourav Mandal"
];
let h4_students = [];
let attendanceState = {};

// DOM ELEMENTS
const splashScreen = document.getElementById("splash-screen");
const attendanceList = document.getElementById("attendance-list");
const subjectSelector = document.getElementById("attendance-subject");
const totalPresent = document.getElementById("total-present");
const totalAbsent = document.getElementById("total-absent");
const presentPercentage = document.getElementById("present-percentage");
const absentListElement = document.getElementById("absent-list");
const attendanceTakenBy = document.getElementById("attendance-taken-by");
const historyListElement = document.getElementById("history-list");
const clearHistoryBtn = document.getElementById("clear-history-btn");
const exportExcelBtn = document.getElementById("export-excel-btn");
const attendanceTakerSelect = document.getElementById("attendance-taker-select");
const customTopicInput = document.getElementById("custom-topic-input");
const yearSelect = document.getElementById("year-select");
const saveBtn = document.getElementById("save-data-btn");
const attendanceDate = document.getElementById("attendance-date");
const loginForm = document.getElementById("login-form");
const loginScreen = document.getElementById("login-screen");
const appContent = document.getElementById("app-content");
const loginError = document.getElementById("login-error");
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const createGMeetBtn = document.getElementById("create-gmeet-btn");
const meetingSummaryInput = document.getElementById("meeting-summary");
const removeSelectedBtn = document.getElementById("remove-selected-btn");
const digitalClock = document.getElementById("digital-clock");
const personalReportBody = document.getElementById("personal-report-body");
const newMemberNameInput = document.getElementById("new-member-name");
const newMemberGroupSelect = document.getElementById("new-member-group");
const customGroupInput = document.getElementById("custom-group-input");
const addMemberBtn = document.getElementById("add-member-btn");
const removeMemberSelect = document.getElementById("remove-member-select");
const removeMemberBtn = document.getElementById("remove-member-btn");
const scheduleInitiatorSelect = document.getElementById("schedule-initiator-select");
const scheduleRecipientSelect = document.getElementById("schedule-recipient-select");
const senderEmailInput = document.getElementById("sender-email");
const recipientEmailInput = document.getElementById("recipient-email");
const scheduleSubjectInput = document.getElementById("schedule-subject");
const scheduleDateInput = document.getElementById("schedule-date");
const scheduleTimeInput = document.getElementById("schedule-time");
const scheduleLocationTypeSelect = document.getElementById("schedule-location-type");
const scheduleLocationDetailsInput = document.getElementById("schedule-location-details");
const scheduleMeetingBtn = document.getElementById("schedule-meeting-btn");
const newPermanentGroupInput = document.getElementById("new-permanent-group"); 
const addPermanentGroupBtn = document.getElementById("add-permanent-group-btn"); 
const tabLinks = document.querySelectorAll('.tab-link');
const tabContents = document.querySelectorAll('.tab-content');
const projectNameInput = document.getElementById("project-name");
const projectTypeSelect = document.getElementById("project-type");
const projectMembersInput = document.getElementById("project-members");
const projectLinkInput = document.getElementById("project-link");
const projectStartInput = document.getElementById("project-start");
const projectEndInput = document.getElementById("project-end");
const addProjectBtn = document.getElementById("add-project-btn");
const liveProjectsList = document.getElementById("live-projects-list");
const recentProjectsList = document.getElementById("recent-projects-list");
const chatDisplay = document.getElementById('chat-display');
const chatInput = document.getElementById('chat-input');
const chatSendBtn = document.getElementById('chat-send-btn');
const toggleAuthBtn = document.getElementById('toggle-auth-btn');
const loginBtn = document.getElementById('login-btn');
const authTitle = document.getElementById('auth-title');
const registrationFields = document.getElementById('registration-fields');
const regNameInput = document.getElementById('reg-name');
const regYearSelect = document.getElementById('reg-year');
const regBatchInput = document.getElementById('reg-batch');
const userAvatarDisplay = document.getElementById('user-avatar-display');
// Profile Elements
const profileIdInput = document.getElementById('profile-id');
const profileNameInput = document.getElementById('profile-name');
const profileYearSelect = document.getElementById('profile-year');
const profileBatchInput = document.getElementById('profile-batch');
const updateProfileBtn = document.getElementById('update-profile-btn');
const logoutBtn = document.getElementById('logout-btn');
const profilePicInput = document.getElementById('profile-pic-input');
const profilePreview = document.getElementById('profile-preview');
const sendOtpBtn = document.getElementById('send-otp-btn');
const verifyOtpBtn = document.getElementById('verify-otp-btn');
const otpInputWrapper = document.getElementById('otp-input-wrapper');
const otpInput = document.getElementById('otp-input');
const otpStatus = document.getElementById('otp-status');
const togglePasswordBtn = document.getElementById('toggle-password');
const techGate = document.getElementById('tech-gate');

// --- AUTH & PROFILE LOGIC ---
const USERS_KEY = "cicr_auth_users";
let isRegistering = false;
let currentUser = null;
let generatedOTP = null;
let isVerified = false;

function getStoredUsers() {
    return JSON.parse(localStorage.getItem(USERS_KEY) || "{}");
}

function saveStoredUsers(users) {
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

function toggleAuthMode() {
    isRegistering = !isRegistering;
    if (isRegistering) {
        authTitle.textContent = "NEW USER REGISTRATION";
        loginBtn.textContent = "REGISTER & LOGIN";
        toggleAuthBtn.textContent = "Back to Login";
        registrationFields.style.display = 'block';
        loginError.style.display = 'none';
        // OTP Section
        document.getElementById('otp-section').style.display = 'block';
        otpInputWrapper.style.display = 'none';
        sendOtpBtn.style.display = 'block';
        isVerified = false;
        otpStatus.textContent = "";
    } else {
        authTitle.textContent = "AUTHORIZED ACCESS";
        loginBtn.textContent = "LOGIN";
        toggleAuthBtn.textContent = "Create New Account";
        registrationFields.style.display = 'none';
        loginError.style.display = 'none';
    }
}

// TOGGLE PASSWORD VISIBILITY
togglePasswordBtn.addEventListener('click', () => {
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    
    // Toggle SVG Icons
    const showIcon = togglePasswordBtn.querySelector('.eye-show');
    const hideIcon = togglePasswordBtn.querySelector('.eye-hide');
    
    if(type === 'password') {
        showIcon.style.display = 'block';
        hideIcon.style.display = 'none';
    } else {
        showIcon.style.display = 'none';
        hideIcon.style.display = 'block';
    }
});

// OTP LOGIC
sendOtpBtn.addEventListener('click', () => {
    const contact = usernameInput.value;
    if(!contact) { alert("Enter Email/Phone first"); return; }
    
    // Simulate OTP
    generatedOTP = Math.floor(100000 + Math.random() * 900000);
    alert(`[SIMULATION] Your OTP code is: ${generatedOTP}`);
    
    sendOtpBtn.style.display = 'none';
    otpInputWrapper.style.display = 'block';
    otpStatus.textContent = "OTP Sent. Check your device.";
});

verifyOtpBtn.addEventListener('click', () => {
    if(otpInput.value == generatedOTP) {
        isVerified = true;
        otpStatus.textContent = "VERIFIED âœ“";
        otpStatus.style.color = "var(--color-success)";
        otpInputWrapper.style.display = 'none';
    } else {
        alert("Incorrect OTP");
    }
});

function loadUserProfile() {
    if (!currentUser) return;
    
    // Set Avatar (Photo or First Letter)
    if (currentUser.avatar) {
        userAvatarDisplay.style.backgroundImage = `url(${currentUser.avatar})`;
        userAvatarDisplay.textContent = "";
        profilePreview.style.backgroundImage = `url(${currentUser.avatar})`;
    } else {
        const initial = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : '?';
        userAvatarDisplay.style.backgroundImage = "none";
        userAvatarDisplay.textContent = initial;
        profilePreview.style.backgroundImage = "none";
        profilePreview.textContent = ""; 
    }
    
    userAvatarDisplay.style.display = 'flex';

    // Populate Account Tab
    profileIdInput.value = currentUser.id;
    profileNameInput.value = currentUser.name;
    profileYearSelect.value = currentUser.year || "1st Year";
    profileBatchInput.value = currentUser.batch || "";
}

function handleProfilePicUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Image = e.target.result;
            // Update Preview
            profilePreview.style.backgroundImage = `url(${base64Image})`;
            currentUser.tempAvatar = base64Image; 
        };
        reader.readAsDataURL(file);
    }
}

// GATE ANIMATION TRIGGER
function operateGate(callback) {
    // Close Gate
    techGate.classList.add('active');
    
    // Wait for transition (0.8s) + delay
    setTimeout(() => {
        // Execute Action
        if(callback) callback();
        
        // Open Gate after short delay
        setTimeout(() => {
             techGate.classList.remove('active');
        }, 1000);
    }, 1200);
}

function updateProfile() {
    operateGate(() => {
        if (!currentUser) return;
        const users = getStoredUsers();
        
        currentUser.name = profileNameInput.value.trim();
        currentUser.year = profileYearSelect.value;
        currentUser.batch = profileBatchInput.value.trim();
        
        if (currentUser.tempAvatar) {
            currentUser.avatar = currentUser.tempAvatar;
            delete currentUser.tempAvatar;
        }
        
        if (users[currentUser.id]) {
            users[currentUser.id].name = currentUser.name;
            users[currentUser.id].year = currentUser.year;
            users[currentUser.id].batch = currentUser.batch;
            if(currentUser.avatar) users[currentUser.id].avatar = currentUser.avatar;
            saveStoredUsers(users);
            showSuccessAnimation();
            loadUserProfile(); 
        }
    });
}

function logout() {
    operateGate(() => {
        currentUser = null;
        userAvatarDisplay.style.display = 'none';
        appContent.style.display = 'none';
        loginScreen.style.display = 'block';
        usernameInput.value = '';
        passwordInput.value = '';
        if(isRegistering) toggleAuthMode();
    });
}

// --- SUCCESS ANIMATION FUNCTION ---
function showSuccessAnimation() {
    const overlay = document.getElementById('action-success-overlay');
    overlay.style.display = 'flex';
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 2000); 
}

// --- BACKGROUND PARTICLES ---
const canvas = document.getElementById('particles-canvas');
const ctx = canvas.getContext('2d');
let particles = [];
function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
class Particle {
    constructor() {
        this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 1.5; this.vy = (Math.random() - 0.5) * 1.5;
        this.size = Math.random() * 2 + 1; this.color = '#66fcf1';
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
        if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
    }
    draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
}
function initParticles() {
    particles = [];
    const count = Math.floor(window.innerWidth / 15);
    for (let i = 0; i < count; i++) particles.push(new Particle());
}
function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < particles.length; i++) {
        particles[i].update(); particles[i].draw();
        for (let j = i; j < particles.length; j++) {
            const dx = particles[i].x - particles[j].x;
            const dy = particles[i].y - particles[j].y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 150) {
                ctx.strokeStyle = `rgba(69, 162, 158, ${1 - dist/150})`;
                ctx.lineWidth = 1; ctx.beginPath();
                ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke();
            }
        }
    }
    requestAnimationFrame(animateParticles);
}
initParticles(); animateParticles();

// --- TAB LOGIC ---
function switchTab(targetTabId) {
    tabLinks.forEach(link => { link.classList.remove('active'); link.setAttribute('aria-selected', 'false'); });
    tabContents.forEach(content => { content.classList.remove('active'); content.style.display = 'none'; });
    const activeLink = document.querySelector(`.tab-link[data-tab="${targetTabId}"]`);
    const activeContent = document.getElementById(`${targetTabId}-content`);
    if (activeLink && activeContent) {
        activeLink.classList.add('active'); activeLink.setAttribute('aria-selected', 'true');
        activeContent.classList.add('active'); activeContent.style.display = 'block';
        if (targetTabId === 'history') renderHistory();
        else if (targetTabId === 'reports') calculatePersonalReport();
        else if (targetTabId === 'projects') renderProjects();
        else if (targetTabId === 'chat') { loadChat(); scrollChat(); }
        else if (targetTabId === 'admin') { populateGroupSelects(); populateRemoveMemberDropdown(); }
        else if (targetTabId === 'account') { loadUserProfile(); }
    }
}

// --- PROJECT MANAGEMENT FUNCTIONS ---
function loadProjects() { return JSON.parse(localStorage.getItem("cicrProjects") || "[]"); }
function saveProject() {
    const name = projectNameInput.value.trim();
    const type = projectTypeSelect.value;
    const members = projectMembersInput.value.trim();
    const link = projectLinkInput.value.trim();
    const start = projectStartInput.value;
    const end = projectEndInput.value;

    if (!name || !members || !start) { alert("Error: Name, Members, and Start Date are required."); return; }

    operateGate(() => {
        const newProject = { id: Date.now(), name, type, members, link, start, end };
        const projects = loadProjects();
        projects.push(newProject);
        localStorage.setItem("cicrProjects", JSON.stringify(projects));
        
        showSuccessAnimation();
        
        projectNameInput.value = ""; projectMembersInput.value = ""; projectLinkInput.value = ""; 
        projectStartInput.value = ""; projectEndInput.value = "";
        renderProjects();
    });
}
function renderProjects() {
    const projects = loadProjects();
    liveProjectsList.innerHTML = "";
    recentProjectsList.innerHTML = "";

    const liveProjects = projects.filter(p => p.type === 'live');
    const recentProjects = projects.filter(p => p.type === 'recent');

    if (liveProjects.length === 0) liveProjectsList.innerHTML = '<p style="opacity:0.6; font-size:13px;">No live projects active.</p>';
    if (recentProjects.length === 0) recentProjectsList.innerHTML = '<p style="opacity:0.6; font-size:13px;">No recent projects logged.</p>';

    const createCard = (p) => `
        <div class="project-card">
            <h4>${p.name}</h4>
            <div class="project-info"><strong>Members:</strong> ${p.members}</div>
            <div class="project-info"><strong>Timeline:</strong> ${p.start} to ${p.end || 'Ongoing'}</div>
            ${p.link ? `<div class="project-link"><a href="${p.link}" target="_blank">ðŸ”— View Project Link</a></div>` : ''}
            <button class="btn-delete-project" onclick="deleteProject(${p.id})">DELETE</button>
        </div>
    `;

    liveProjects.forEach(p => liveProjectsList.innerHTML += createCard(p));
    recentProjects.forEach(p => recentProjectsList.innerHTML += createCard(p));
}
window.deleteProject = function(id) {
    if(!confirm("Delete this project?")) return;
    let projects = loadProjects();
    projects = projects.filter(p => p.id !== id);
    localStorage.setItem("cicrProjects", JSON.stringify(projects));
    renderProjects();
};

// --- CHAT LOGIC ---
function loadChat() {
    const chat = JSON.parse(localStorage.getItem("cicrChat") || "[]");
    chatDisplay.innerHTML = "";
    if(chat.length === 0) {
        // Welcome message
        chatDisplay.innerHTML = `<div class="chat-message msg-other"><span class="msg-meta">SYSTEM | NOW</span>Welcome to the CICR Secure Channel. Start communicating.</div>`;
    }
    chat.forEach(msg => {
        const div = document.createElement("div");
        div.className = `chat-message ${msg.sender === (currentUser ? currentUser.name : 'ME') ? 'msg-self' : 'msg-other'}`;
        div.innerHTML = `<span class="msg-meta">${msg.sender} | ${msg.time}</span>${msg.text}`;
        chatDisplay.appendChild(div);
    });
}
function postMessage() {
    const text = chatInput.value.trim();
    if(!text) return;
    
    const chat = JSON.parse(localStorage.getItem("cicrChat") || "[]");
    const senderName = currentUser ? currentUser.name : "ME";
    
    const msg = {
        sender: senderName,
        text: text,
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    chat.push(msg);
    if(chat.length > 50) chat.shift(); // Keep last 50
    localStorage.setItem("cicrChat", JSON.stringify(chat));
    
    chatInput.value = "";
    loadChat();
    scrollChat();
}
function scrollChat() {
    chatDisplay.scrollTop = chatDisplay.scrollHeight;
}

// --- DATA FUNCTIONS ---
function loadGroups() {
    const storedGroups = localStorage.getItem("cicrGroups");
    if (storedGroups) ALL_GROUPS = JSON.parse(storedGroups);
    else { ALL_GROUPS = ["4th Year", "3rd Year", "2nd Year", "1st Year"]; saveGroups(); }
}
function saveGroups() { localStorage.setItem("cicrGroups", JSON.stringify(ALL_GROUPS)); populateGroupSelects(); renderStudents(); }
function addPermanentGroup(groupName) {
    const trimmedName = groupName.trim();
    if (trimmedName === "" || ALL_GROUPS.map(g => g.toLowerCase()).includes(trimmedName.toLowerCase())) return false;
    ALL_GROUPS.push(trimmedName); saveGroups(); return true;
}
function loadStudents() {
	const storedStudents = localStorage.getItem("cicrMembers");
	if (storedStudents) {
        h4_students = JSON.parse(storedStudents);
        populateAttendanceTakerDropdown();
        populateRemoveMemberDropdown();
        populateSchedulingDropdowns();
    } else { 
        h4_students = DEFAULT_STUDENTS; 
        saveStudents(); 
    }
}
function saveStudents() { localStorage.setItem("cicrMembers", JSON.stringify(h4_students)); populateAttendanceTakerDropdown(); populateRemoveMemberDropdown(); populateSchedulingDropdowns(); }

// --- UI FUNCTIONS ---
function updateClock() {
	const now = new Date();
	const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
	const dateString = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: '2-digit' });
	digitalClock.textContent = `${dateString} | ${timeString}`;
}
function populateGroupSelects() {
    const currentSelectedGroups = Array.from(yearSelect.selectedOptions).map(o => o.value);
    yearSelect.innerHTML = "";
    ALL_GROUPS.forEach(group => {
        const option = document.createElement("option"); option.value = group; option.textContent = group;
        if (currentSelectedGroups.includes(group)) option.selected = true; yearSelect.appendChild(option);
    });
    if(yearSelect.selectedOptions.length === 0 && yearSelect.options.length > 0) {
        const defaultOpt = Array.from(yearSelect.options).find(o => o.value === "1st Year") || yearSelect.options[0];
        if(defaultOpt) defaultOpt.selected = true;
    }

    const currentNewMemberGroup = newMemberGroupSelect.value;
    newMemberGroupSelect.innerHTML = '';
    ALL_GROUPS.forEach(group => {
        const option = document.createElement('option'); option.value = group; option.textContent = group.toUpperCase(); newMemberGroupSelect.appendChild(option);
    });
    const customOption = document.createElement('option'); customOption.value = "Custom"; customOption.textContent = "Custom Unit..."; newMemberGroupSelect.appendChild(customOption);
    if (newMemberGroupSelect.querySelector(`option[value="${currentNewMemberGroup}"]`)) newMemberGroupSelect.value = currentNewMemberGroup;
    else newMemberGroupSelect.value = ALL_GROUPS[0] || "Custom";
}
function populateAttendanceTakerDropdown() {
	attendanceTakerSelect.innerHTML = '<option value="" disabled selected>-- Select Member --</option>';
	h4_students.forEach(student => { 
        const option = document.createElement("option"); 
        option.value = student; 
        option.textContent = student.includes(": ") ? student.split(": ")[1] : student; 
        attendanceTakerSelect.appendChild(option); 
    });
}
function populateRemoveMemberDropdown() {
	removeMemberSelect.innerHTML = '<option value="" disabled selected>-- Select User to Remove --</option>';
	h4_students.forEach(student => { const option = document.createElement("option"); option.value = student; option.textContent = student; removeMemberSelect.appendChild(option); });
}
function populateSchedulingDropdowns() {
	scheduleInitiatorSelect.innerHTML = '<option value="" disabled selected>-- Select Sender --</option>';
	scheduleRecipientSelect.innerHTML = '<option value="" disabled selected>-- Select Recipient --</option>';
	h4_students.forEach(studentData => {
		const name = studentData.includes(": ") ? studentData.split(": ")[1] : studentData;
		const initiatorOption = document.createElement("option"); initiatorOption.value = name; initiatorOption.textContent = name; scheduleInitiatorSelect.appendChild(initiatorOption);
		const recipientOption = document.createElement("option"); recipientOption.value = name; recipientOption.textContent = name; scheduleRecipientSelect.appendChild(recipientOption);
	});
}
function getMeetingTopic() { return subjectSelector.value === "Other" && customTopicInput.value.trim() !== "" ? customTopicInput.value.trim() : subjectSelector.options[subjectSelector.selectedIndex].textContent; }
function updateSubjectDisplay() { document.getElementById("current-subject-display").textContent = getMeetingTopic(); }
function handleTopicChange() {
	if (subjectSelector.value === "Other") { customTopicInput.style.display = "block"; customTopicInput.focus(); } else { customTopicInput.style.display = "none"; customTopicInput.value = ""; } updateSubjectDisplay();
}
function handleGroupChange() {
	const customInputWrapper = document.getElementById("custom-group-input-wrapper");
	if (newMemberGroupSelect.value === "Custom") { customInputWrapper.style.display = "block"; customGroupInput.focus(); } else { customInputWrapper.style.display = "none"; customGroupInput.value = ""; }
}

// --- CORE LOGIC ---
function addMember() {
	const name = newMemberNameInput.value.trim();
	let group = newMemberGroupSelect.value;
	if (!name) return alert("Error: Enter new user name.");
	if (group === "Custom") { group = customGroupInput.value.trim(); if (!group) return alert("Error: Enter custom unit name."); }
    if (!ALL_GROUPS.includes(group)) { if (confirm(`Warning: Group "${group}" is not registered. Add it?`)) addPermanentGroup(group); }
	const newMemberString = `${group}: ${name}`;
	if (h4_students.some(s => s.toLowerCase() === newMemberString.toLowerCase())) return alert(`Error: User already exists.`);
	h4_students.push(newMemberString); h4_students.sort(); saveStudents(); alert(`Success: User ${name} added.`);
	newMemberNameInput.value = ""; populateGroupSelects(); renderStudents();
}
function removeMember() {
	const memberToRemove = removeMemberSelect.value;
	if (!memberToRemove) return alert("Error: Select a user.");
	if (!confirm(`Confirm remove "${memberToRemove}"?`)) return;
	const index = h4_students.indexOf(memberToRemove);
	if (index > -1) { h4_students.splice(index, 1); saveStudents(); alert(`Success: User removed.`); } renderStudents();
}
function getSelectedGroups() { return Array.from(yearSelect.selectedOptions).map(o => o.value); }
function renderStudents() {
	attendanceList.innerHTML = ""; attendanceState = {};
	const selectedGroups = getSelectedGroups();
	const filteredStudents = h4_students.filter(student => selectedGroups.includes(student.split(": ")[0]));
	if (filteredStudents.length === 0) {
        attendanceList.innerHTML = selectedGroups.length === 0 ? `<li style="padding: 15px; opacity: 0.7; color: #fff;">Select at least one Group/Unit to load members.</li>` : `<li style="padding: 15px; color: var(--color-danger);">No users found matching selected units.</li>`;
		updateSummary(); return;
	}
	filteredStudents.sort((a, b) => a.localeCompare(b));
	filteredStudents.forEach((studentData, index) => {
		const [role, name] = studentData.split(": ");
		const studentKey = studentData;
		attendanceState[studentKey] = "MARK";
		const listItem = document.createElement("li"); listItem.className = "student-item unmarked"; listItem.id = studentKey.replace(/[^a-zA-Z0-9]/g, "_");
		listItem.innerHTML = `<div class="student-info"><div><div class="student-name">${name}</div><div class="student-id">${role}</div></div></div><div class="status-controls"><button class="status-button btn-present" data-key="${studentKey}" style="opacity: 0.4;">Present</button><button class="status-button btn-absent" data-key="${studentKey}" style="opacity: 0.4;">Absent</button><button class="status-button btn-unmarked" data-key="${studentKey}" style="opacity: 1.0;">Reset</button></div>`;
		attendanceList.appendChild(listItem);
	});
	attendanceList.querySelectorAll(".status-button").forEach(button => {
		button.addEventListener("click", e => {
			const key = e.target.getAttribute("data-key");
			const status = e.target.textContent.toUpperCase();
			attendanceState[key] = (status === "RESET") ? "MARK" : status;
			const listItem = document.getElementById(key.replace(/[^a-zA-Z0-9]/g, "_"));
			const controls = listItem.querySelector(".status-controls");
			controls.querySelectorAll(".status-button").forEach(btn => btn.style.opacity = '0.4');
			listItem.classList.remove("present", "absent", "unmarked");
			if (status === "PRESENT") listItem.classList.add("present"); else if (status === "ABSENT") listItem.classList.add("absent"); else listItem.classList.add("unmarked");
			e.target.style.opacity = '1.0'; updateSummary();
		});
	});
	updateSummary();
}
function updateSummary() {
	let presentCount = 0, absentCount = 0, absentNames = [];
	for (const key in attendanceState) { if (attendanceState[key] === "PRESENT") presentCount++; else if (attendanceState[key] === "ABSENT") { absentCount++; absentNames.push(key.split(": ")[1]); } }
	const total = Object.keys(attendanceState).length;
	const percentage = total > 0 ? ((presentCount / total) * 100).toFixed(1) : "0.0";
	totalPresent.textContent = presentCount; totalAbsent.textContent = absentCount; presentPercentage.textContent = `${percentage}%`;
	presentPercentage.classList.toggle("poor", parseFloat(percentage) < 70);
	absentListElement.innerHTML = absentNames.length > 0 ? absentNames.map(name => `<li>${name}</li>`).join("") : '<li style="color: var(--color-success);">No absences recorded.</li>';
}
function saveData() {
	const selectedGroups = getSelectedGroups();
	if (Object.keys(attendanceState).length === 0 || selectedGroups.length === 0) return alert("Error: Select group and mark users.");
	if (!attendanceDate.value) return alert("Error: Select date.");
	if (attendanceTakerSelect.value === "") return alert("Error: Select recorder.");
    const unmarkedCount = Object.values(attendanceState).filter(s => s === "MARK").length;
	if (unmarkedCount > 0 && !confirm(`Warning: ${unmarkedCount} users unmarked. Commit?`)) return;
	
    operateGate(() => {
        const history = JSON.parse(localStorage.getItem("attendanceHistory") || "[]");
        const attendanceRecords = Object.keys(attendanceState).map(key => { const [group, name] = key.split(": "); return { name, group, status: attendanceState[key] }; });
        const newRecord = { id: Date.now(), date: attendanceDate.value, topic: getMeetingTopic(), group: selectedGroups.join(', '), taker: attendanceTakerSelect.options[attendanceTakerSelect.selectedIndex].textContent, summary: meetingSummaryInput.value.trim() || "No summary.", attendance: attendanceRecords };
        history.unshift(newRecord); localStorage.setItem("attendanceHistory", JSON.stringify(history)); 
        
        showSuccessAnimation();
        
        Array.from(yearSelect.options).forEach(o => o.selected = false); attendanceState = {}; attendanceTakenBy.textContent = "Attendance Recorded By: [None Selected]"; renderStudents();
    });
}
function renderHistory() {
	const history = JSON.parse(localStorage.getItem("attendanceHistory") || "[]");
	historyListElement.innerHTML = history.length === 0 ? '<li style="padding: 15px; opacity: 0.6;">No logs available.</li>' : "";
    document.getElementById("remove-selected-btn").style.display = history.length ? 'block' : 'none';
	document.getElementById("clear-history-btn").style.display = history.length ? 'block' : 'none';
	history.forEach(record => {
		const listItem = document.createElement("li"); listItem.className = "history-item";
		const presentCount = record.attendance.filter(a => a.status === "PRESENT").length;
		const totalCount = record.attendance.filter(a => a.status !== "MARK").length;
        const percentage = totalCount > 0 ? ((presentCount / totalCount) * 100).toFixed(0) : 0;
		listItem.innerHTML = `<div class="history-header-wrapper"><input type="checkbox" class="history-checkbox" data-id="${record.id}" style="width: auto; margin-right: 10px;"><button class="history-header-btn" onclick="this.parentElement.nextElementSibling.style.display = this.parentElement.nextElementSibling.style.display === 'none' ? 'block' : 'none'"><span>[${record.date}] ${record.topic}</span><span style="font-weight: 700; color: var(--color-accent);">${presentCount}/${totalCount} (${percentage}%)</span></button></div><div class="history-details" style="display:none;"><p><strong>Recorder:</strong> ${record.taker}</p><p><strong>Summary:</strong> ${record.summary}</p><p><strong>Full Record:</strong></p><ul class="full-record-list">${record.attendance.map(a => `<li style="color:${a.status === 'PRESENT' ? 'var(--color-success)' : 'var(--color-danger)'}">${a.name} [${a.status}]</li>`).join("")}</ul></div>`;
		historyListElement.appendChild(listItem);
	});
}
function clearHistory() { if (confirm("Delete ALL logs?")) { localStorage.removeItem("attendanceHistory"); renderHistory(); } }
function removeSelectedRecords() {
    const checkboxes = document.querySelectorAll('.history-checkbox:checked');
    if (!checkboxes.length) return alert("Select records.");
    if (!confirm("Delete selected?")) return;
    let history = JSON.parse(localStorage.getItem("attendanceHistory") || "[]");
    const ids = Array.from(checkboxes).map(c => parseInt(c.getAttribute('data-id')));
    history = history.filter(r => !ids.includes(r.id)); localStorage.setItem("attendanceHistory", JSON.stringify(history)); renderHistory();
}

// FIX: CSV EXPORT FUNCTION
function exportToCSV() {
    const history = JSON.parse(localStorage.getItem("attendanceHistory") || "[]");
    if (history.length === 0) { alert("No logs to export."); return; }

    let csvContent = "data:text/csv;charset=utf-8,";
    // Header Row
    csvContent += "Date,Topic,Group,Recorder,Summary,Student Name,Student Group,Status\n";

    history.forEach(record => {
        const date = record.date;
        const topic = record.topic.replace(/,/g, " "); // Remove commas to prevent CSV break
        const group = record.group.replace(/,/g, " ");
        const recorder = record.taker.replace(/,/g, " ");
        const summary = record.summary.replace(/,/g, " ");

        record.attendance.forEach(att => {
            const row = `${date},${topic},${group},${recorder},${summary},${att.name},${att.group},${att.status}`;
            csvContent += row + "\n";
        });
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `CICR_Attendance_Report_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- NEW SCHEDULING FUNCTION ---
function handleScheduleMeeting() {
    // 1. Gather Values
    const initiator = scheduleInitiatorSelect.value;
    const recipient = scheduleRecipientSelect.value;
    const senderEmail = senderEmailInput.value.trim();
    const recipientEmail = recipientEmailInput.value.trim();
    const subject = scheduleSubjectInput.value.trim();
    const date = scheduleDateInput.value;
    const time = scheduleTimeInput.value;
    const locType = scheduleLocationTypeSelect.value;
    const locDetails = scheduleLocationDetailsInput.value.trim();

    // 2. Validation
    if (!recipientEmail || !subject || !date || !time) {
        alert("Error: Please fill in the required fields (Recipient Email, Subject, Date, Time).");
        return;
    }

    // 3. Construct Email Body
    const body = `Meeting Invitation\n\n` +
                 `Topic: ${subject}\n` +
                 `Date: ${date}\n` +
                 `Time: ${time}\n` +
                 `Location: ${locType} ${locDetails ? `(${locDetails})` : ''}\n\n` +
                 `Attendees: ${initiator} (Host), ${recipient}\n\n` +
                 `Please confirm your availability.\n\n` +
                 `Regards,\n${initiator || 'CICR Admin'}`;

    // 4. Create Mailto Link (Generates the email draft)
    const mailtoLink = `mailto:${recipientEmail}?cc=${senderEmail}&subject=${encodeURIComponent("INVITE: " + subject)}&body=${encodeURIComponent(body)}`;

    // 5. Execute
    window.location.href = mailtoLink;
}

function calculatePersonalReport() {
    const history = JSON.parse(localStorage.getItem("attendanceHistory") || "[]");
    const reportData = {};
    h4_students.forEach(m => reportData[m] = { total: 0, attended: 0, group: m.split(": ")[0], name: m.split(": ")[1] });
    history.forEach(r => r.attendance.forEach(a => { const key = `${a.group}: ${a.name}`; if (reportData[key] && a.status !== "MARK") { reportData[key].total++; if (a.status === "PRESENT") reportData[key].attended++; } }));
    personalReportBody.innerHTML = "";
    Object.keys(reportData).sort().forEach(key => {
        const d = reportData[key];
        const pct = d.total > 0 ? ((d.attended / d.total) * 100).toFixed(1) : "N/A";
        personalReportBody.innerHTML += `<tr><td>${d.name}</td><td>${d.group}</td><td style="text-align:right;">${pct === "N/A" ? "N/A" : `${pct}% (${d.attended}/${d.total})`}</td></tr>`;
    });
}

// --- INIT ---
function initializeListeners() {
	setInterval(updateClock, 1000); updateClock();
    splashScreen.addEventListener('click', () => { splashScreen.style.opacity = '0'; setTimeout(() => { splashScreen.style.display = 'none'; loginScreen.style.display = 'block'; }, 500); });
	
    toggleAuthBtn.addEventListener("click", toggleAuthMode);
    
    // LOGIN & REGISTER HANDLER
    loginForm.addEventListener("submit", (e) => {
		e.preventDefault();
        const enteredUser = usernameInput.value.trim();
        const enteredPass = passwordInput.value.trim();

        if (!enteredUser || !enteredPass) {
            loginError.textContent = "Please fill in all fields.";
            loginError.style.display = 'block';
            return;
        }

        const users = getStoredUsers();

        if (isRegistering) {
            if(!isVerified) {
                alert("Please verify your phone/email via OTP first.");
                return;
            }

            // REGISTER
            const name = regNameInput.value.trim();
            const year = regYearSelect.value;
            const batch = regBatchInput.value.trim();

            if (!name || !batch) {
                loginError.textContent = "Name and Batch are required.";
                loginError.style.display = 'block';
                return;
            }

            if (users[enteredUser]) {
                loginError.textContent = "User already exists. Please login.";
                loginError.style.display = 'block';
            } else {
                operateGate(() => {
                    // SAVE NEW USER OBJECT
                    users[enteredUser] = {
                        id: enteredUser,
                        password: enteredPass,
                        name: name,
                        year: year,
                        batch: batch
                    };
                    saveStoredUsers(users);
                    alert("Account Created! You can now login.");
                    toggleAuthMode(); // Switch back to login view
                });
            }
        } else {
            // LOGIN
            operateGate(() => {
                // 1. Check Master Admin
                if (enteredUser === USERNAME && enteredPass === PASSWORD) {
                    currentUser = { id: "ADMIN", name: "Administrator", year: "Staff", batch: "N/A" };
                    loginSuccess();
                } 
                // 2. Check Personal User (Object check)
                else if (users[enteredUser] && users[enteredUser].password === enteredPass) {
                    currentUser = users[enteredUser];
                    loginSuccess();
                } 
                // 3. Fallback for old string-only passwords
                else if (users[enteredUser] === enteredPass) {
                     currentUser = { id: enteredUser, name: "Member", year: "N/A", batch: "N/A" };
                     loginSuccess();
                }
                else { 
                    // Manual Gate Re-open if failed
                    setTimeout(() => { techGate.classList.remove('active'); }, 500);
                    loginError.textContent = "Access Denied. Invalid Credentials.";
                    loginError.style.display = 'block'; 
                    passwordInput.value = ''; 
                }
            });
        }
	});

    function loginSuccess() {
        loginScreen.style.display = 'none';
        const successScreen = document.getElementById('success-screen');
        successScreen.style.display = 'flex';
        
        // Populate profile immediately
        loadUserProfile();

        setTimeout(() => {
            successScreen.style.display = 'none';
            appContent.style.display = 'block';
            loadGroups(); loadStudents(); populateGroupSelects(); switchTab('attendance');
        }, 2000);
    }

    tabLinks.forEach(link => link.addEventListener('click', (e) => switchTab(e.target.getAttribute('data-tab'))));
	attendanceTakerSelect.addEventListener("change", () => attendanceTakenBy.textContent = `Attendance Recorded By: ${attendanceTakerSelect.value.split(": ")[1]}`);
	yearSelect.addEventListener("change", renderStudents);
	customTopicInput.addEventListener("input", updateSubjectDisplay);
	subjectSelector.addEventListener("change", handleTopicChange);
	saveBtn.addEventListener("click", saveData);
	createGMeetBtn.addEventListener("click", () => window.open(`https://calendar.google.com/calendar/r/eventedit?text=${encodeURIComponent(getMeetingTopic())}`, '_blank'));
	clearHistoryBtn.addEventListener("click", clearHistory);
    removeSelectedBtn.addEventListener("click", removeSelectedRecords);
	exportExcelBtn.addEventListener("click", exportToCSV);
    
    // --- ADDED EVENT LISTENER FOR SCHEDULING ---
    scheduleMeetingBtn.addEventListener("click", handleScheduleMeeting);

    addPermanentGroupBtn.addEventListener("click", () => { if(addPermanentGroup(newPermanentGroupInput.value)) { alert("Group Added"); newPermanentGroupInput.value=""; } else alert("Error"); });
	newMemberGroupSelect.addEventListener("change", handleGroupChange);
	addMemberBtn.addEventListener("click", addMember);
	removeMemberBtn.addEventListener("click", removeMember);
    addProjectBtn.addEventListener("click", saveProject);
    chatSendBtn.addEventListener("click", postMessage);
    chatInput.addEventListener("keypress", (e) => { if(e.key === 'Enter') postMessage(); });
    updateProfileBtn.addEventListener("click", updateProfile);
    logoutBtn.addEventListener("click", logout);
    userAvatarDisplay.addEventListener("click", () => switchTab('account'));
    
    // PHOTO UPLOAD LISTENER
    profilePicInput.addEventListener('change', handleProfilePicUpload);

    const todayISO = new Date().toISOString().split('T')[0];
    attendanceDate.value = todayISO; scheduleDateInput.value = todayISO; projectStartInput.value = todayISO;
    document.getElementById('open-calendar-btn').addEventListener('click', () => attendanceDate.showPicker());
    document.getElementById('open-calendar-scheduler-btn').addEventListener('click', () => scheduleDateInput.showPicker());
    document.getElementById('open-calendar-start-btn').addEventListener('click', () => projectStartInput.showPicker());
    document.getElementById('open-calendar-end-btn').addEventListener('click', () => projectEndInput.showPicker());
    loadGroups(); loadStudents();
}
initializeListeners();
</script>
</body>
</html>
